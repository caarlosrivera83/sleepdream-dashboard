<!doctype html><meta charset="utf-8">
<title>SleepDream Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:16px;max-width:1100px;margin:auto}
  h1{margin:0 0 8px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .full{grid-column:1 / -1}
  .card{border:1px solid #ddd;border-radius:12px;padding:12px}
  .muted{color:#555}
  select,button{padding:6px 10px;border-radius:8px;border:1px solid #ccc}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e5e5;padding:6px;text-align:left}
  th{background:#fafafa}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;margin-left:6px}
</style>

<h1>SleepDream – Panel</h1>
<div class="muted" id="last">Cargando…</div>

<div style="margin:10px 0; display:flex; gap:10px; align-items:center;">
  <label>Dispositivo:</label>
  <select id="deviceSel"><option value="">Todos</option></select>
  <label style="margin-left:10px;">Ventana:</label>
  <select id="winSel">
    <option value="2">2 h</option>
    <option value="6">6 h</option>
    <option value="12">12 h</option>
    <option value="24" selected>24 h</option>
  </select>
  <button id="refreshBtn">Actualizar</button>
</div>

<div class="row">
  <div class="card"><canvas id="ruido"></canvas></div>
  <div class="card"><canvas id="pulso"></canvas></div>
  <div class="card full"><canvas id="spo2"></canvas></div>
</div>

<div class="row" style="margin-top:16px;">
  <div class="card full">
    <h3 style="margin-top:0">Últimos registros</h3>
    <table id="tbl">
      <thead><tr><th>Hora</th><th>Ruido dB</th><th>Pico dB</th><th>Umbral</th><th>Over</th><th>BPM</th><th>SpO₂ %</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card full">
    <h3 style="margin-top:0">Eventos de ruido (umbral superado)</h3>
    <table id="tblev">
      <thead><tr><th>Inicio</th><th>Fin</th><th>Pico dB</th><th>Umbral</th><th>Muestras</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="muted">Requiere vista <code>ruido_eventos</code>.</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const PROJECT = "tqxiecgruhcnpuvciypa";  // tu project ref
const ANON    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxeGllY2dydWhjbnB1dmNpeXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NTkzODQsImV4cCI6MjA3NjAzNTM4NH0.FOdMzy8O2mdTD0ObEcy34Jllue5lzMsOGqFIs6QFlLU";
const REST = `https://${PROJECT}.supabase.co/rest/v1`;

const H = {
  apikey: ANON,
  Authorization: "Bearer " + ANON
};

const deviceSel = document.getElementById('deviceSel');
const winSel    = document.getElementById('winSel');
const lastLbl   = document.getElementById('last');
document.getElementById('refreshBtn').onclick = () => loadAll();

// --- Utils ---
function isoHoursAgo(h){ return new Date(Date.now() - h*3600e3).toISOString(); }
function fmtTime(s){ return new Date(s).toLocaleTimeString(); }
function fmtDate(s){ return new Date(s).toLocaleString(); }

async function fetchJSON(url){
  const r = await fetch(url, { headers: H });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

// Distintos dispositivos (de lecturas últimas 24h)
async function loadDevices(){
  const since = isoHoursAgo(24);
  const url = `${REST}/lecturas?select=dispositivo_id&ts=gte.${since}&order=dispositivo_id.asc`;
  const rows = await fetchJSON(url);
  const ids = [...new Set(rows.map(r => r.dispositivo_id).filter(Boolean))];
  deviceSel.innerHTML = '<option value="">Todos</option>' + ids.map(id =>
    `<option value="${id}">${id.slice(0,8)}…</option>`).join('');
}

// Lecturas (con filtros)
async function loadLecturas(){
  const hours = parseInt(winSel.value, 10);
  const since = isoHoursAgo(hours);
  let url = `${REST}/lecturas?select=ts,dispositivo_id,ruido_db,ruido_peak_db,limit_db,over_limit,pulso_bpm,spo2_pct&ts=gte.${since}&order=ts.asc`;
  const dev = deviceSel.value.trim();
  if (dev) url += `&dispositivo_id=eq.${dev}`;
  return fetchJSON(url);
}

// Eventos (si existe la vista)
async function loadEventos(){
  const hours = parseInt(winSel.value, 10);
  const since = isoHoursAgo(hours);
  // La vista puede no estar; ignoramos error si 404
  let url = `${REST}/ruido_eventos?select=start_ts,end_ts,peak_db,limit_db,samples&start_ts=gte.${since}&order=start_ts.desc`;
  const dev = deviceSel.value.trim();
  if (dev) url += `&dispositivo_id=eq.${dev}`;
  try { return await fetchJSON(url); }
  catch(e){ console.warn("Eventos no disponibles:", e.message); return []; }
}

// Charts
let ruidoChart, pulsoChart, spo2Chart;
function makeLine(ctx, labels, datasets, yTitle){
  return new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, animation: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: { ticks: { maxRotation: 0 } },
        y: { title: { display: true, text: yTitle } }
      },
      plugins: { legend: { labels: { boxWidth: 12 } } }
    }
  });
}

function renderLecturas(rows){
  // Labels
  const labels = rows.map(r => fmtTime(r.ts));

  // Ruido
  const ruido = rows.map(r => r.ruido_db ?? null);
  const peak  = rows.map(r => r.ruido_peak_db ?? null);
  // Umbral: si cambia por fila, usamos valor de la fila; si null, repetimos anterior
  const limit = [];
  let lastLim = null;
  for (const r of rows){
    lastLim = (r.limit_db ?? lastLim ?? null);
    limit.push(lastLim);
  }

  // Pulso y SpO2
  const bpm  = rows.map(r => r.pulso_bpm ?? null);
  const spo2 = rows.map(r => r.spo2_pct ?? null);

  // (Re)crear o actualizar charts
  if (!ruidoChart) {
    ruidoChart = makeLine(document.getElementById('ruido'),
      labels,
      [
        { label: 'Ruido (dB)', data: ruido, tension: 0.2 },
        { label: 'Pico (dB)', data: peak, tension: 0.2 },
        { label: 'Umbral (dB)', data: limit, tension: 0, borderDash: [6,6] }
      ],
      'dB'
    );
  } else {
    Object.assign(ruidoChart.data, { labels, datasets: [
      { label: 'Ruido (dB)', data: ruido, tension: 0.2 },
      { label: 'Pico (dB)', data: peak, tension: 0.2 },
      { label: 'Umbral (dB)', data: limit, tension: 0, borderDash: [6,6] }
    ]});
    ruidoChart.update();
  }

  if (!pulsoChart) {
    pulsoChart = makeLine(document.getElementById('pulso'),
      labels,
      [{ label: 'BPM', data: bpm, tension: 0.2 }],
      'BPM'
    );
  } else {
    Object.assign(pulsoChart.data, { labels, datasets: [{ label: 'BPM', data: bpm, tension: 0.2 }]});
    pulsoChart.update();
  }

  if (!spo2Chart) {
    spo2Chart = makeLine(document.getElementById('spo2'),
      labels,
      [{ label: 'SpO₂ (%)', data: spo2, tension: 0.2 }],
      '%'
    );
  } else {
    Object.assign(spo2Chart.data, { labels, datasets: [{ label: 'SpO₂ (%)', data: spo2, tension: 0.2 }]});
    spo2Chart.update();
  }

  // Tabla últimos N
  const tb = document.querySelector('#tbl tbody');
  const last = rows.slice(-50).reverse();
  tb.innerHTML = last.map(r => `
    <tr>
      <td>${fmtDate(r.ts)}</td>
      <td>${r.ruido_db ?? ''}</td>
      <td>${r.ruido_peak_db ?? ''}</td>
      <td>${r.limit_db ?? ''}</td>
      <td>${r.over_limit ? 'Sí' : (r.over_limit===false?'No':'')}</td>
      <td>${r.pulso_bpm ?? ''}</td>
      <td>${r.spo2_pct ?? ''}</td>
    </tr>
  `).join('');
}

function renderEventos(rows){
  const tb = document.querySelector('#tblev tbody');
  tb.innerHTML = rows.map(r => `
    <tr>
      <td>${fmtDate(r.start_ts)}</td>
      <td>${fmtDate(r.end_ts)}</td>
      <td>${r.peak_db?.toFixed ? r.peak_db.toFixed(1) : (r.peak_db ?? '')}</td>
      <td>${r.limit_db ?? ''}</td>
      <td>${r.samples ?? ''}</td>
    </tr>
  `).join('');
}

async function loadAll(){
  lastLbl.textContent = 'Actualizando…';
  const [lecturas, eventos] = await Promise.all([loadLecturas(), loadEventos()]);
  renderLecturas(lecturas);
  renderEventos(eventos);
  lastLbl.textContent = 'Última actualización: ' + new Date().toLocaleString();
}

(async () => {
  try {
    await loadDevices();
    await loadAll();
    // Auto-refresh cada 5 s
    setInterval(loadAll, 5000);
  } catch(e){
    document.body.insertAdjacentHTML('beforeend', `<pre style="color:#b00">Error: ${e.message}</pre>`);
  }
})();
</script>
